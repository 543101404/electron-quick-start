<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
  </head>
  <body>
    <h1>Hello World!</h1>
    <!-- All of the Node.js APIs are available in this renderer process. -->
    We are using Node.js <script>document.write(process.versions.node)</script>,
    Chromium <script>document.write(process.versions.chrome)</script>,
    and Electron <script>document.write(process.versions.electron)</script>.
	
	<div class="form-group">
		<label>七、C++ Dll hello</label>
		
		<span id="hello"></span>
		
		
		<div class="demo-controls">
            <button class="demo-button" id="preview">render_preview</button>
			<button class="demo-button" id="printbill">render_printbill</button>
			<br>
			
			<button class="demo-button" id="mainprocess_preview">mainprocess_preview</button>
			<button class="demo-button" id="mainprocess_printbill">mainprocess_printbill</button>
			<span id="async-reply"></span>
          </div>
		
	</div>
	

	

    <script>
      // You can also require other files to run in this process
      require('./renderer.js')
	  var ref = require("ref");
	 var ffi = require("ffi");
	 var path = require('path')
	 var fs = require('fs')

	 const { BrowserWindow } = require('electron').remote

	var win = null;

		/*
		const Dll = ffi.Library('dll/MyDLL.dll', {
				'Add': ['float', ['float', 'float']],
				'Hello': ['string', []],
				'StrLength': ['int', ['string']]
		})*/
		/*
		const testDll = ffi.Library('dll/DllExport32.dll', {

				'Hello': ['string', []]

		})
		document.getElementById('hello').innerHTML = testDll.Hello();
		*/
		
	
		var _void = ref.types.void 
		var _voidPtr = ref.refType(_void);
		//var _stringPtr = ref.refType(ref.types.string);
		//var stringPtr = ref.refType(ref.types.CString);
		var ctrlHandle = null;
	var tb = ffi.Library('dll/tbillonecore.dll', {

				'CreateGeneBillCtrl3': ['int', []],
				'FD':['string',['int', _voidPtr, _voidPtr]]
		})

	var preview = document.getElementById('preview')
	
	var printbill = document.getElementById('printbill')
	
	printbill.addEventListener('click', (event) => {
	
		console.log("printbill");
		if(ctrlHandle == null)
		{
			ctrlHandle = tb.CreateGeneBillCtrl3();
		}
		
	
		var templatelist = fs.readFileSync('./dll/templatelist.json','utf-8');
		var printcfgjson = fs.readFileSync('./dll/printcfg.json','utf-8');
		var taskdata = fs.readFileSync('./dll/taskdata.json','utf-8');
		var curtemplate = path.join('', __dirname, './dll/template.bof');
		

		
		tb.FD(ctrlHandle, Buffer.from('OpenFile\0', 'utf16le'), Buffer.from(curtemplate + '@@1\0', 'utf16le'));
		
		tb.FD(ctrlHandle, Buffer.from('SetPrintCfgJson\0', 'utf16le'), Buffer.from(printcfgjson + '@@1\0', 'utf16le'));
		
		tb.FD(ctrlHandle, Buffer.from('LoadPrintTaskData\0', 'utf16le'), Buffer.from(taskdata+'\0', 'utf16le'));
		
		//tb.FD(ctrlHandle, Buffer.from('PrintPreview\0', 'utf16le'), Buffer.from('2@@'+ templatelist+'\0', 'utf16le'));
		
		tb.FD(ctrlHandle, Buffer.from('PrintBill\0', 'utf16le'), Buffer.from('0\0', 'utf16le'));
		
		
	
		
	})

	preview.addEventListener('click', (event) => {
	
		console.log("preview");
		if(ctrlHandle == null)
		{
			ctrlHandle = tb.CreateGeneBillCtrl3();
		}
		
	
		var templatelist = fs.readFileSync('./dll/templatelist.json','utf-8');
		var printcfgjson = fs.readFileSync('./dll/printcfg.json','utf-8');
		var taskdata = fs.readFileSync('./dll/taskdata.json','utf-8');
		var curtemplate = path.join('', __dirname, './dll/template.bof');
		
		console.log(templatelist);
		console.log(printcfgjson);
		console.log(taskdata);
		console.log(curtemplate);

		
		tb.FD(ctrlHandle, Buffer.from('OpenFile\0', 'utf16le'), Buffer.from(curtemplate + '@@1\0', 'utf16le'));
		
		tb.FD(ctrlHandle, Buffer.from('SetPrintCfgJson\0', 'utf16le'), Buffer.from(printcfgjson + '@@1\0', 'utf16le'));
		
		tb.FD(ctrlHandle, Buffer.from('LoadPrintTaskData\0', 'utf16le'), Buffer.from(taskdata+'\0', 'utf16le'));
		
		tb.FD(ctrlHandle, Buffer.from('PrintPreview\0', 'utf16le'), Buffer.from('0@@'+ templatelist+'\0', 'utf16le'));
		
		//tb.FD(ctrlHandle, Buffer.from('PrintBill\0', 'utf16le'), Buffer.from('0\0', 'utf16le'));
		
		
		
	})
	
	const {ipcRenderer} = require('electron')
	var mainprocess_preview = document.getElementById('mainprocess_preview')
	var mainprocess_printbill = document.getElementById('mainprocess_printbill')
	mainprocess_preview.addEventListener('click', (event) => {
	
		 ipcRenderer.send('asynchronous-message', 'preview')
	})
	
	mainprocess_printbill.addEventListener('click', (event) => {
	
		 ipcRenderer.send('asynchronous-message', 'printbill')
	})

	ipcRenderer.on('asynchronous-reply', (event, arg) => {
	  const message = `Asynchronous message reply: ${arg}`
	  document.getElementById('async-reply').innerHTML = message
	})

	
    </script>
  </body>
</html>
